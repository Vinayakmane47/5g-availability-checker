<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5G Availability Dashboard - Modern</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }
    
    .dashboard-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-primary);
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .map-container {
      height: 400px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      position: relative;
    }
    
    .map-legend {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      box-shadow: var(--shadow-md);
      z-index: 1000;
      font-size: 0.75rem;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    
    .legend-color {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
    }
    
    .legend-color.available {
      background: var(--success-color);
    }
    
    .legend-color.unavailable {
      background: var(--error-color);
    }
    
    .recent-results {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .result-item {
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: var(--radius-md);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    
    .result-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-sm);
    }
    
    .result-address {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }
    
    .result-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
    }
    
    .status-available {
      color: var(--success-color);
    }
    
    .status-unavailable {
      color: var(--error-color);
    }
    
    .status-icon {
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
    }
    
    .status-icon.available {
      background: var(--success-color);
      color: white;
    }
    
    .status-icon.unavailable {
      background: var(--error-color);
      color: white;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .tab.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }
    
    .tab:hover {
      color: var(--text-primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .quick-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="fas fa-moon" id="theme-icon"></i>
      </button>
      <h1>5G Availability Dashboard</h1>
      <p>Comprehensive 5G network coverage analysis and visualization platform</p>
      
      <!-- Navigation -->
      <nav class="flex gap-4 justify-center mt-4">
        <a href="/" class="btn btn-secondary">
          <i class="fas fa-search"></i>
          Checker
        </a>
        <a href="/dashboard" class="btn btn-primary">
          <i class="fas fa-tachometer-alt"></i>
          Dashboard
        </a>
        <a href="/map" class="btn btn-secondary">
          <i class="fas fa-map"></i>
          Map
        </a>
      </nav>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-value" id="total-checks">0</div>
        <div class="stat-label">Total Checks</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="available-count">0</div>
        <div class="stat-label">Available</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="unavailable-count">0</div>
        <div class="stat-label">Unavailable</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="coverage-rate">0%</div>
        <div class="stat-label">Coverage Rate</div>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Checker Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-search"></i>
            Address Checker
          </h2>
        </div>

        <form onsubmit="event.preventDefault(); startWebSocketLive();">
          <div class="form-grid">
            <div class="form-group">
              <label for="address">
                <i class="fas fa-map-marker-alt"></i> Address
              </label>
              <input type="text" id="address" class="form-control" placeholder="e.g. 340 Lygon Street Carlton VIC" required>
            </div>

            <div class="form-group">
              <label for="radius">
                <i class="fas fa-circle"></i> Search Radius
              </label>
              <select id="radius" class="form-control" required>
                <option value="200">200 meters</option>
                <option value="400">400 meters</option>
                <option value="500">500 meters</option>
                <option value="1000" selected>1 kilometer</option>
                <option value="2000">2 kilometers</option>
              </select>
            </div>

            <div class="form-group">
              <label for="n">
                <i class="fas fa-list-ol"></i> Max Addresses
              </label>
              <input type="number" id="n" class="form-control" value="20" min="1" max="200" required>
            </div>

            <div class="form-group">
              <label for="workers">
                <i class="fas fa-cogs"></i> Workers
              </label>
              <input type="number" id="workers" class="form-control" value="6" min="1" max="20" required>
            </div>
          </div>

          <div class="flex gap-4 justify-center">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search"></i>
              Check Live
            </button>
            <button type="button" class="btn btn-secondary" onclick="startWebSocketFromData()">
              <i class="fas fa-database"></i>
              Check Database
            </button>
          </div>
        </form>

        <!-- Loading State -->
        <div id="loading" class="loading-container">
          <div class="loading-spinner"></div>
          <p class="loading-text">Checking 5G availability...</p>
          <div class="progress-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
          </div>
        </div>

        <!-- Error Messages -->
        <div id="error" class="error-message hidden">
          <i class="fas fa-exclamation-triangle"></i>
          <span id="error-text"></span>
        </div>
      </div>

      <!-- Map Section -->
      <div class="dashboard-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-map"></i>
            Coverage Map
          </h2>
          <div class="flex gap-2">
            <button class="btn btn-secondary" onclick="clearMap()">
              <i class="fas fa-trash"></i>
              Clear
            </button>
            <button class="btn btn-secondary" onclick="exportMapData()">
              <i class="fas fa-download"></i>
              Export
            </button>
          </div>
        </div>

        <div class="map-container">
          <div id="map"></div>
          
          <div class="map-legend">
            <div class="legend-item">
              <div class="legend-color available"></div>
              <span>Available</span>
            </div>
            <div class="legend-item">
              <div class="legend-color unavailable"></div>
              <span>Unavailable</span>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <div class="form-grid">
            <div class="form-group">
              <label for="map-source">Data Source</label>
              <select id="map-source" class="form-control">
                <option value="live">Live (Overpass)</option>
                <option value="csv" selected>From CSV</option>
              </select>
            </div>
            <div class="form-group">
              <label for="map-bbox">Bounding Box</label>
              <input type="text" id="map-bbox" class="form-control" value="-37.8265,144.9475,-37.8060,144.9835" placeholder="south,west,north,east">
            </div>
          </div>
          <div class="flex justify-center mt-4">
            <button class="btn btn-primary" onclick="startMap()">
              <i class="fas fa-play"></i>
              Start Mapping
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-list"></i>
          Recent Results
        </h2>
        <div class="tabs">
          <button class="tab active" onclick="switchTab('results')">Results</button>
          <button class="tab" onclick="switchTab('analytics')">Analytics</button>
        </div>
      </div>

      <div id="results-tab" class="tab-content active">
        <div id="results" class="recent-results"></div>
        <div class="mt-4 text-center">
          <button class="btn btn-secondary" onclick="exportResults()">
            <i class="fas fa-download"></i>
            Export Results
          </button>
          <button class="btn btn-secondary" onclick="clearResults()">
            <i class="fas fa-trash"></i>
            Clear Results
          </button>
        </div>
      </div>

      <div id="analytics-tab" class="tab-content">
        <div class="text-center">
          <p class="text-muted">Analytics dashboard coming soon...</p>
        </div>
      </div>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // Theme Management
    function toggleTheme() {
      const html = document.documentElement;
      const themeIcon = document.getElementById('theme-icon');
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      if (newTheme === 'dark') {
        themeIcon.className = 'fas fa-sun';
      } else {
        themeIcon.className = 'fas fa-moon';
      }
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      const themeIcon = document.getElementById('theme-icon');
      if (savedTheme === 'dark') {
        themeIcon.className = 'fas fa-sun';
      }
    }

    // Tab Management
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName + '-tab').classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');
    }

    // Data Management
    let resultsData = [];
    let mapData = [];
    let totalChecked = 0;
    let availableCount = 0;
    let unavailableCount = 0;

    function updateStats() {
      document.getElementById('total-checks').textContent = totalChecked;
      document.getElementById('available-count').textContent = availableCount;
      document.getElementById('unavailable-count').textContent = unavailableCount;
      
      const coverage = totalChecked > 0 ? Math.round((availableCount / totalChecked) * 100) : 0;
      document.getElementById('coverage-rate').textContent = coverage + '%';
    }

    // Map Management
    let map, layer;

    function initMap() {
      map = L.map('map').setView([-37.8136, 144.9631], 14);
      
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const tileLayer = isDark 
        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      
      L.tileLayer(tileLayer, {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      
      layer = L.layerGroup().addTo(map);
    }

    function clearMap() {
      if (layer) {
        layer.clearLayers();
        mapData = [];
      }
    }

    function addMapMarker(lat, lon, text, available) {
      const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          width: 10px; 
          height: 10px; 
          background: ${available ? 'var(--success-color)' : 'var(--error-color)'}; 
          border: 2px solid white; 
          border-radius: 50%; 
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        "></div>`,
        iconSize: [10, 10],
        iconAnchor: [5, 5]
      });
      
      const m = L.marker([lat, lon], { icon }).bindPopup(text);
      layer.addLayer(m);
      mapData.push({ lat, lon, text, available });
    }

    function startMap() {
      if (!map) initMap();
      clearMap();

      const source = document.getElementById("map-source").value;
      const bboxStr = document.getElementById("map-bbox").value.trim();
      const parts = bboxStr.split(",").map(s => parseFloat(s.trim()));
      
      if (parts.length !== 4 || parts.some(isNaN)) {
        alert("Invalid bounding box format. Use: south,west,north,east");
        return;
      }

      const ws = new WebSocket("ws://" + location.host + "/ws_map");
      ws.onopen = () => ws.send(JSON.stringify({ bbox: parts, workers: 3, max_points: 100 }));
      
      ws.onmessage = (event) => {
        const d = JSON.parse(event.data);
        if (d.error) { 
          console.error(d.error); 
          return; 
        }
        if (d.lat != null && d.lon != null) {
          const text = `${d.addr}<br/>${d.available ? '&#10004; 5G Available' : '&#10006; 5G Unavailable'}`;
          addMapMarker(d.lat, d.lon, text, d.available);
        }
      };
    }

    function exportMapData() {
      if (mapData.length === 0) {
        alert("No map data to export");
        return;
      }
      
      const csv = [
        ['Latitude', 'Longitude', 'Address', 'Available'],
        ...mapData.map(d => [
          d.lat,
          d.lon,
          d.text.replace(/<br\/>.*/, ''),
          d.available ? 'Yes' : 'No'
        ])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `5g-map-data-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Results Management
    function addResultLine(data) {
      const div = document.createElement("div");
      div.className = "result-item";
      
      const statusClass = data.available ? 'status-available' : 'status-unavailable';
      const statusIcon = data.available ? 'fas fa-check' : 'fas fa-times';
      const statusText = data.available ? 'Available' : 'Not Available';
      
      const coordinates = (data.lat != null && data.lon != null)
        ? `<span class="text-muted">(${Number(data.lat).toFixed(6)}, ${Number(data.lon).toFixed(6)})</span>`
        : "";

      const distance = (typeof data.distance_km === "number")
        ? `<span class="text-muted">- ${data.distance_km.toFixed(2)} km away</span>`
        : "";

      div.innerHTML = `
        <div class="result-address">${data.addr}</div>
        <div class="result-status ${statusClass}">
          <span class="status-icon ${data.available ? 'available' : 'unavailable'}">
            <i class="${statusIcon}"></i>
          </span>
          ${statusText}
          ${coordinates}
          ${distance}
        </div>
      `;

      document.getElementById("results").appendChild(div);
      
      // Update stats
      totalChecked++;
      if (data.available) availableCount++;
      else unavailableCount++;
      updateStats();
      
      // Store data for export
      resultsData.push(data);
    }

    function resetUI() {
      document.getElementById("results").innerHTML = "";
      document.getElementById("error").className = "error-message hidden";
      document.getElementById("loading").style.display = "block";
      document.getElementById("progress-bar").style.width = "0%";
      
      window._startTime = performance.now();
    }

    function finishUI() {
      document.getElementById("loading").style.display = "none";
      
      const totalTime = ((performance.now() - window._startTime) / 1000).toFixed(2);
      
      const summary = document.createElement("div");
      summary.className = "success-message mt-4";
      summary.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span><strong>Check completed!</strong> Total time: ${totalTime} seconds</span>
      `;
      document.getElementById("results").appendChild(summary);
    }

    function showError(message) {
      const errorDiv = document.getElementById("error");
      const errorText = document.getElementById("error-text");
      errorText.textContent = message;
      errorDiv.className = "error-message";
      document.getElementById("loading").style.display = "none";
    }

    function startWebSocketLive() {
      resetUI();
      const address = document.getElementById("address").value;
      const n = parseInt(document.getElementById("n").value);
      const workers = parseInt(document.getElementById("workers").value);
      const radius = parseInt(document.getElementById("radius").value);

      const ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws");
      
      ws.onopen = () => {
        ws.send(JSON.stringify({ address, n, workers, radius }));
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress > 90) progress = 90;
          document.getElementById("progress-bar").style.width = progress + "%";
        }, 500);
        
        ws.progressInterval = progressInterval;
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.error) {
          showError(data.error);
          ws.close();
          return;
        }
        addResultLine(data);
        document.getElementById("progress-bar").style.width = "95%";
      };
      
      ws.onclose = () => {
        if (ws.progressInterval) clearInterval(ws.progressInterval);
        document.getElementById("progress-bar").style.width = "100%";
        setTimeout(finishUI, 500);
      };
    }

    function startWebSocketFromData() {
      resetUI();
      const address = document.getElementById("address").value;
      const n = 10;

      const ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws_fromdata");
      
      ws.onopen = () => {
        ws.send(JSON.stringify({ address, n }));
        document.getElementById("progress-bar").style.width = "50%";
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.error) {
          showError(data.error);
          ws.close();
          return;
        }
        addResultLine(data);
        document.getElementById("progress-bar").style.width = "100%";
      };
      
      ws.onclose = () => {
        setTimeout(finishUI, 300);
      };
    }

    function exportResults() {
      if (resultsData.length === 0) {
        showError("No results to export");
        return;
      }
      
      const csv = [
        ['Address', 'Available', 'Status', 'Latitude', 'Longitude', 'Distance (km)', 'Checked At', 'Source'],
        ...resultsData.map(r => [
          r.addr,
          r.available ? 'Yes' : 'No',
          r.status || '',
          r.lat || '',
          r.lon || '',
          r.distance_km || '',
          r.checked_at || '',
          r.source || ''
        ])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `5g-results-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function clearResults() {
      document.getElementById("results").innerHTML = "";
      resultsData = [];
    }

    // Initialize
    initTheme();
    initMap();
  </script>
</body>
</html> 