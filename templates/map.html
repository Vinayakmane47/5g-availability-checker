<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5G Availability Map - Modern</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
  <style>
    .map-controls {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
    }
    
    .map-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-primary);
    }
    
    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .map-legend {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1rem;
      box-shadow: var(--shadow-md);
      z-index: 1000;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }
    
    .legend-color {
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
    }
    
    .legend-color.available {
      background: var(--success-color);
    }
    
    .legend-color.unavailable {
      background: var(--error-color);
    }
    
    .map-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1rem 2rem;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      display: none;
    }

    .map-container {
      position: relative;
      height: 600px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
    }

    #map {
      height: 100%;
      width: 100%;
    }

    .mapboxgl-popup-content {
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      line-height: 1.4;
      border-radius: var(--radius-md);
      padding: 1rem;
      box-shadow: var(--shadow-lg);
    }
    
    .mapboxgl-popup-close-button {
      font-size: 1.2rem;
      padding: 0.5rem;
    }
    
    .marker-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .marker-dot:hover {
      transform: scale(1.3);
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    .marker-dot.available {
      background: #10B981;
    }
    
    .marker-dot.unavailable {
      background: #EF4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <i class="fas fa-moon" id="theme-icon"></i>
      </button>
      <h1>5G Availability Map</h1>
      <p>Visualize 5G network coverage across Melbourne CBD with modern mapping technology.</p>
      
      <!-- Navigation -->
      <nav class="flex gap-4 justify-center mt-4">
        <a href="/" class="btn btn-secondary">
          <i class="fas fa-search"></i>
          Checker
        </a>
        <a href="/dashboard" class="btn btn-secondary">
          <i class="fas fa-tachometer-alt"></i>
          Dashboard
        </a>
        <a href="/map" class="btn btn-primary">
          <i class="fas fa-map"></i>
          Map
        </a>
      </nav>
    </div>

    <!-- Map Controls -->
    <div class="map-controls">
      <div class="form-grid">
        <div class="form-group">
          <label for="source">
            <i class="fas fa-database"></i> Data Source
          </label>
          <select id="source" class="form-control">
            <option value="csv" selected>From Database (results.csv)</option>
            <option value="live">Live Check (Overpass API)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="bbox">
            <i class="fas fa-map"></i> Bounding Box
          </label>
          <input type="text" id="bbox" class="form-control" value="-37.8265,144.9475,-37.8060,144.9835" placeholder="south,west,north,east">
        </div>

        <div class="form-group">
          <label for="workers">
            <i class="fas fa-cogs"></i> Workers
          </label>
          <input type="number" id="workers" class="form-control" value="3" min="1" max="12">
        </div>

        <div class="form-group">
          <label for="max_points">
            <i class="fas fa-chart-scatter"></i> Max Points
          </label>
          <input type="number" id="max_points" class="form-control" value="500" min="1" max="3000">
        </div>
      </div>

      <div class="flex gap-4 justify-center mt-4">
        <button class="btn btn-primary" onclick="startMap()">
          <i class="fas fa-play"></i>
          Load Map Data
        </button>
        <button class="btn btn-secondary" onclick="clearMap()">
          <i class="fas fa-trash"></i>
          Clear Map
        </button>
        <button class="btn btn-secondary" onclick="exportMapData()">
          <i class="fas fa-download"></i>
          Export Data
        </button>
      </div>

      <div class="mt-4 text-center">
        <p class="text-muted">
          <i class="fas fa-info-circle"></i>
          <strong>Database Mode:</strong> Shows all 5G availability data from your results.csv
          <br>
          <strong>Live Mode:</strong> Real-time checking from Overpass API (slower)
        </p>
      </div>
    </div>

    <!-- Map Stats -->
    <div class="map-stats">
      <div class="stat-item">
        <div class="stat-number" id="total-points">0</div>
        <div class="stat-label">Total Points</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="available-points">0</div>
        <div class="stat-label">5G Available</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="unavailable-points">0</div>
        <div class="stat-label">5G Unavailable</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="coverage-percentage">0%</div>
        <div class="stat-label">Coverage</div>
      </div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
      <div id="map"></div>
      
      <!-- Map Legend -->
      <div class="map-legend">
        <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Legend</h4>
        <div class="legend-item">
          <div class="legend-color available"></div>
          <span>5G Available</span>
        </div>
        <div class="legend-item">
          <div class="legend-color unavailable"></div>
          <span>5G Unavailable</span>
        </div>
      </div>
      
      <!-- Map Loading -->
      <div class="map-loading" id="map-loading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading map data...</p>
      </div>
    </div>
  </div>

  <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
  <script>
    // Theme Management
    function toggleTheme() {
      const html = document.documentElement;
      const themeIcon = document.getElementById('theme-icon');
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      if (newTheme === 'dark') {
        themeIcon.className = 'fas fa-sun';
      } else {
        themeIcon.className = 'fas fa-moon';
      }
      
      // Update map tiles if map exists
      if (map) {
        updateMapTiles();
      }
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      const themeIcon = document.getElementById('theme-icon');
      if (savedTheme === 'dark') {
        themeIcon.className = 'fas fa-sun';
      }
    }

    // Mapbox Access Token - REPLACE WITH YOUR TOKEN
    // Get your free token at: https://account.mapbox.com/access-tokens/
    mapboxgl.accessToken = 'pk.eyJ1IjoiZXhhbXBsZSIsImEiOiJjbGV4YW1wbGUifQ.example'; // REPLACE THIS!
    
    // Map Management
    let map;
    let markers = [];
    let mapData = [];
    let totalPoints = 0;
    let availablePoints = 0;
    let unavailablePoints = 0;

    function updateStats() {
      document.getElementById('total-points').textContent = totalPoints;
      document.getElementById('available-points').textContent = availablePoints;
      document.getElementById('unavailable-points').textContent = unavailablePoints;
      
      const coverage = totalPoints > 0 ? Math.round((availablePoints / totalPoints) * 100) : 0;
      document.getElementById('coverage-percentage').textContent = coverage + '%';
    }

    function updateMapTiles() {
      if (!map) return;
      
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      
      // Set Mapbox style based on theme
      if (isDark) {
        map.setStyle('mapbox://styles/mapbox/dark-v11');
      } else {
        map.setStyle('mapbox://styles/mapbox/streets-v12');
      }
    }

    function initMap() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      
      map = new mapboxgl.Map({
        container: 'map',
        style: isDark ? 'mapbox://styles/mapbox/dark-v11' : 'mapbox://styles/mapbox/streets-v12',
        center: [144.9631, -37.8136], // [lng, lat] - Melbourne CBD
        zoom: 13,
        pitch: 0,
        bearing: 0
      });
      
      // Add navigation controls
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      
      // Add fullscreen control
      map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
      
      // Add scale control
      map.addControl(new mapboxgl.ScaleControl({
        maxWidth: 100,
        unit: 'metric'
      }), 'bottom-left');
      
      console.log('Mapbox map initialized');
    }

    function clearMarkers() {
      // Remove all markers
      markers.forEach(marker => marker.remove());
      markers = [];
      
      mapData = [];
      totalPoints = 0;
      availablePoints = 0;
      unavailablePoints = 0;
      updateStats();
    }

    function addMarker(lat, lon, text, available) {
      // Create marker element
      const el = document.createElement('div');
      el.className = `marker-dot ${available ? 'available' : 'unavailable'}`;
      
      // Create popup
      const popup = new mapboxgl.Popup({
        offset: 25,
        closeButton: true,
        closeOnClick: false
      }).setHTML(text);
      
      // Create and add marker
      const marker = new mapboxgl.Marker(el)
        .setLngLat([lon, lat])
        .setPopup(popup)
        .addTo(map);
      
      markers.push(marker);
      
      // Update stats
      totalPoints++;
      if (available) availablePoints++;
      else unavailablePoints++;
      updateStats();
      
      // Store data
      mapData.push({ lat, lon, text, available });
    }

    function showMapLoading() {
      document.getElementById('map-loading').style.display = 'block';
    }

    function hideMapLoading() {
      document.getElementById('map-loading').style.display = 'none';
    }

    function startMap() {
      if (!map) initMap();
      clearMarkers();
      showMapLoading();

      const source = document.getElementById("source").value;
      const workers = parseInt(document.getElementById("workers").value);
      const max_points = parseInt(document.getElementById("max_points").value);

      console.log(`Starting map with source: ${source}, workers: ${workers}, max_points: ${max_points}`);

      if (source === "live") {
        const bboxStr = document.getElementById("bbox").value.trim();
        const parts = bboxStr.split(",").map(s => parseFloat(s.trim()));
        if (parts.length !== 4 || parts.some(isNaN)) {
          alert("Invalid bounding box format. Use: south,west,north,east");
          hideMapLoading();
          return;
        }
        
        const ws = new WebSocket("ws://" + location.host + "/ws_map");
        ws.onopen = () => {
          console.log("WebSocket opened for live mode");
          ws.send(JSON.stringify({ bbox: parts, workers, max_points }));
        };
        
        ws.onmessage = (event) => {
          const d = JSON.parse(event.data);
          console.log("Received data:", d);
          if (d.error) { 
            console.error(d.error); 
            hideMapLoading();
            return; 
          }
          if (d.lat != null && d.lon != null) {
            const text = `${d.addr}<br/>${d.available ? '&#10004; 5G Available' : '&#10006; 5G Unavailable'}`;
            addMarker(d.lat, d.lon, text, d.available);
          }
        };
        
        ws.onclose = () => {
          console.log("WebSocket closed");
          hideMapLoading();
        };
        
        ws.onerror = (error) => {
          console.error("WebSocket error:", error);
          hideMapLoading();
        };
      } else {
        // Use REST API instead of WebSocket for database mode
        console.log("Loading data from REST API...");
        fetch(`/api/map-data?max_points=${max_points}`)
          .then(response => response.json())
          .then(data => {
            console.log("Received data from API:", data);
            if (data.error) {
              console.error(data.error);
              hideMapLoading();
              return;
            }
            
            if (data.success && data.data) {
              data.data.forEach(d => {
                if (d.lat != null && d.lon != null) {
                  const text = `${d.addr}<br/>${d.available ? '&#10004; 5G Available' : '&#10006; 5G Unavailable'}`;
                  addMarker(d.lat, d.lon, text, d.available);
                }
              });
              console.log(`Loaded ${data.count} addresses on map`);
            }
            hideMapLoading();
          })
          .catch(error => {
            console.error("Error loading map data:", error);
            hideMapLoading();
          });
      }
    }

    function clearMap() {
      if (layer) {
        clearMarkers();
      }
    }

    function exportMapData() {
      if (mapData.length === 0) {
        alert("No map data to export");
        return;
      }
      
      const csv = [
        ['Latitude', 'Longitude', 'Address', 'Available'],
        ...mapData.map(d => [
          d.lat,
          d.lon,
          d.text.replace(/<br\/>.*/, ''), // Remove HTML tags
          d.available ? 'Yes' : 'No'
        ])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `5g-map-data-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

    // Initialize
    initTheme();
    initMap();
    
    // Auto-load data when page loads
    setTimeout(() => {
      console.log("Auto-loading map data...");
      startMap();
    }, 1000);
  </script>
</body>
</html>
